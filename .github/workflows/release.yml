name: Auto Release

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Component to release (e.g. dummy_app, md-binance, lib-orderbook)"
        required: true
      bump:
        description: "Version bump type: major | minor | patch"
        required: true

jobs:
  generate-tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag for this component
        id: last
        run: |
          COMPONENT="${{ github.event.inputs.component }}"
          TAGS=$(git tag --list "${COMPONENT}-v*" | sort -V)

          if [ -z "$TAGS" ]; then
            LAST_VERSION="0.0.0"
          else
            LAST_VERSION=$(echo "$TAGS" | tail -n1 | sed "s/${COMPONENT}-v//")
          fi

          echo "last_version=$LAST_VERSION" >> $GITHUB_OUTPUT

      - name: Compute next version
        id: bump
        run: |
          BUMP="${{ github.event.inputs.bump }}"
          CUR="${{ steps.last.outputs.last_version }}"

          IFS='.' read -r MAJ MIN PAT <<< "$CUR"

          case "$BUMP" in
            major) MAJ=$((MAJ+1)); MIN=0; PAT=0 ;;
            minor) MIN=$((MIN+1)); PAT=0 ;;
            patch) PAT=$((PAT+1)) ;;
            *) echo "invalid bump type '$BUMP'"; exit 1 ;;
          esac

          NEW="$MAJ.$MIN.$PAT"
          TAG="${{ github.event.inputs.component }}-v${NEW}"

          echo "new_tag=$TAG" >> $GITHUB_OUTPUT
          echo "New tag: $TAG"

      - name: Create and push tag
        run: |
          git config user.name "GitHub CI"
          git config user.email "ci@github.com"
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

