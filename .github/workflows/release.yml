name: PET Release

on:
  push:
    tags:
      - "*"     # any tag triggers release

permissions:
  contents: write      # required to create releases + upload assets
  packages: read       # required to pull GHCR toolchain image
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Pull toolchain image
        run: docker pull ghcr.io/paraskh/pet-toolchain:latest

      - name: Build inside toolchain
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/paraskh/pet-toolchain:latest \
            bash -c "
              cmake -B build-Release -S . \
                -DCMAKE_TOOLCHAIN_FILE=cmake/pet_toolchain.cmake \
                -DCMAKE_BUILD_TYPE=Release &&
              cmake --build build-Release -j &&
              cmake --install build-Release --prefix dist
            "

      - name: Verify dist directory
        run: ls -R dist

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: pet-dist
          path: dist/**
          if-no-files-found: error

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: PET Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            dist/**

